name: Merge main to qa

on:
  workflow_call:
    inputs:
      WORKFLOW_DISPATCH_NAME:
        default: 'Jenkins'
        description: 'Workflow to trigger after merge.'
        required: false
        type: string

env:
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  merge-main-to-qa:
    name: Merge
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      - name: Set Git config
        run: |
            git config --local user.name "Github Actions"
      - name: Merge main back to qa
        run: |
          git fetch

          # make sure qa is latest
          git checkout qa
          git pull

          # make sure main is latest
          git checkout main
          git pull

          # create a temporary sync-master2qa branch to resolve conflict
          git checkout -b sync-main2qa
          # merge qa into sync-main2qa auto resolve by taking master branch code
          git merge -s ours --no-edit --allow-unrelated-histories qa

          # merge temp branch sync-main2qa into qa
          git checkout qa
          git merge --no-edit --allow-unrelated-histories sync-main2qa

          # remove the temp branch we just created
          git branch -D sync-main2qa

          # push code back to qa
          git push origin qa

          # trigger gh actions within the repo to deploy qa branch to pmcqa
          gh workflow run "${{ inputs.WORKFLOW_DISPATCH_NAME }}" -r "qa"


